# Orderflow Service

A Bun-based HTTP service for handling order operations in the Aztec OTC Desk.

## Endpoints

### POST /order
Create a new order. The `orderId` is automatically generated by the server.

**Important**: Each `escrowAddress` can only be used once. Attempting to create an order with an existing escrow address will return a 409 Conflict error.

**Request Body:**
```json
{
  "escrowAddress": "0x1234...",
  "sellTokenAddress": "0x5678...",
  "sellTokenAmount": "1000000000000000000",
  "buyTokenAddress": "0x9abc...",
  "buyTokenAmount": "2000000000000000000"
}
```

**Request:**
```bash
curl -X POST http://localhost:3000/order \
  -H "Content-Type: application/json" \
  -d '{
    "escrowAddress": "0x1234567890abcdef1234567890abcdef12345678",
    "sellTokenAddress": "0x5678901234abcdef5678901234abcdef56789012",
    "sellTokenAmount": "1000000000000000000",
    "buyTokenAddress": "0x9abcdef123456789abcdef123456789abcdef12",
    "buyTokenAmount": "2000000000000000000"
  }'
```

**Response:**
```json
{
  "success": true,
  "message": "Order created successfully",
  "data": {
    "orderId": "generated-uuid-here",
    "escrowAddress": "0x1234567890abcdef1234567890abcdef12345678",
    "sellTokenAddress": "0x5678901234abcdef5678901234abcdef56789012",
    "sellTokenAmount": "1000000000000000000",
    "buyTokenAddress": "0x9abcdef123456789abcdef123456789abcdef12",
    "buyTokenAmount": "2000000000000000000"
  }
}
```

**Error Response (409 Conflict):**
```json
{
  "success": false,
  "error": "Order with escrow address 0x1234567890abcdef1234567890abcdef12345678 already exists"
}
```

### GET /order
Retrieve order(s). Optionally specify an order ID using the `id` query parameter.

**Request:**
```bash
# Get all orders
curl http://localhost:3000/order

# Get specific order
curl http://localhost:3000/order?id=123
```

## Development

### Install Dependencies
```bash
bun install
```

### Run in Development Mode
```bash
bun run dev
```

### Run in Production Mode
```bash
bun run start
```

### Build
```bash
bun run build
```

## Database

The service uses a **pluggable database architecture** with a clean interface that supports multiple database backends.

### Current Implementation
- **Default**: SQLite using Bun's built-in SQLite support
- **Database file**: `orders.sqlite` (created automatically in project root)

### Database Architecture
The service uses an interface-based approach (`IDatabase`) that allows easy swapping of database implementations:

```typescript
// Current usage (SQLite)
import { database } from "./db";

// Easy to swap for different implementations
import { PostgreSQLDatabase } from "./db/examples/postgres";
const database = new PostgreSQLDatabase("connection-string");
```

### Database Schema
```sql
CREATE TABLE orders (
  orderId TEXT PRIMARY KEY,
  escrowAddress TEXT NOT NULL UNIQUE,
  sellTokenAddress TEXT NOT NULL,
  sellTokenAmount TEXT NOT NULL,
  buyTokenAddress TEXT NOT NULL,
  buyTokenAmount TEXT NOT NULL,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## Implementation Status

✅ **POST /order** - Fully implemented with SQLite persistence
⚠️ **GET /order** - Scaffold only (placeholder implementation)

## TODO

- [x] Implement order creation logic in `handleCreateOrder`
- [x] Add database integration with SQLite
- [x] Add UUID generation for order IDs
- [x] Implement pluggable database architecture with interfaces
- [x] Add unique constraint for escrow addresses
- [ ] Implement order retrieval logic in `handleGetOrder`
- [ ] Add input validation and sanitization
- [ ] Add authentication and authorization
- [ ] Add error handling and logging
- [ ] Add tests
- [ ] Implement alternative database providers (PostgreSQL, MongoDB, etc.)
